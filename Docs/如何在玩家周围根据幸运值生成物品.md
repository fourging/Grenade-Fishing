# 手雷炸鱼Mod开发指南

## 概述

本指南介绍如何在玩家周围根据幸运值生成物品，特别适用于手雷炸鱼Mod的开发。文档包含核心API说明、参数详解和实用代码示例。

## 核心系统架构

### 1. 物品生成系统

#### Item.Drop() 方法

这是在指定位置生成物品的核心方法。

```csharp
// 基础方法：在指定位置生成物品
Item.Drop(Vector3 position, bool createRigidbody, Vector3 dropDirection, float randomAngle)

// 便捷方法：在角色位置生成物品
Item.Drop(CharacterMainControl character, bool createRigidbody)
```

**参数说明：**
- `position`: 物品生成的世界坐标位置
- `createRigidbody`: 是否为物品添加刚体组件，启用物理效果
- `dropDirection`: 物品掉落的方向向量
- `randomAngle`: 物品生成时的随机旋转角度范围
- `character`: 角色控制器，用于获取位置和方向信息

### 2. 幸运值系统

#### 获取玩家幸运值

```csharp
float luck = character.CharacterItem.GetStatValue("FishingQualityFactor".GetHashCode());
```

**参数说明：**
- `character`: 角色控制器实例
- `"FishingQualityFactor"`: 幸运值属性键，可根据游戏实际配置调整
- `GetHashCode()`: 将字符串键转换为哈希值以提高查询效率

**返回值：**
- 返回一个浮点数，通常范围在0.0-1.0之间，表示玩家的幸运程度

## 手雷炸鱼实现方案

### 方案一：简单实现

```csharp
public class GrenadeFishing : MonoBehaviour
{
    [Header("炸鱼配置")]
    public int minFishCount = 1;        // 最小鱼数量
    public int maxFishCount = 5;        // 最大鱼数量
    public float spawnRadius = 3f;      // 生成半径
    public float luckMultiplier = 1.5f; // 幸运值倍数
    
    [Header("鱼类配置")]
    public int[] commonFishIDs;         // 普通鱼类ID数组
    public int[] rareFishIDs;           // 稀有鱼类ID数组
    
    /// <summary>
    /// 在爆炸位置生成鱼
    /// </summary>
    /// <param name="explosionPosition">爆炸位置</param>
    /// <param name="player">玩家角色</param>
    public void SpawnFishAtExplosion(Vector3 explosionPosition, CharacterMainControl player)
    {
        // 获取玩家幸运值
        float luck = GetPlayerLuck(player) * luckMultiplier;
        
        // 根据幸运值计算鱼的数量
        int fishCount = CalculateFishCount(luck);
        
        // 生成鱼
        for (int i = 0; i < fishCount; i++)
        {
            SpawnSingleFish(explosionPosition, luck);
        }
    }
    
    /// <summary>
    /// 获取玩家幸运值
    /// </summary>
    private float GetPlayerLuck(CharacterMainControl player)
    {
        if (player == null || player.CharacterItem == null)
            return 0.5f; // 默认幸运值
            
        return player.CharacterItem.GetStatValue("FishingQualityFactor".GetHashCode());
    }
    
    /// <summary>
    /// 根据幸运值计算鱼的数量
    /// </summary>
    private int CalculateFishCount(float luck)
    {
        // 使用线性插值计算鱼的数量
        return Mathf.RoundToInt(Mathf.Lerp(minFishCount, maxFishCount, luck));
    }
    
    /// <summary>
    /// 生成单条鱼
    /// </summary>
    private void SpawnSingleFish(Vector3 centerPosition, float luck)
    {
        // 在爆炸位置周围随机选择生成点
        Vector3 randomPos = centerPosition + Random.insideUnitSphere * spawnRadius;
        randomPos.y = centerPosition.y; // 保持与爆炸点同一高度
        
        // 根据幸运值选择鱼的种类
        int fishID = SelectFishType(luck);
        
        // 创建鱼物品实例
        Item fishItem = CreateFishItem(fishID);
        
        if (fishItem != null)
        {
            // 在随机位置生成鱼，添加物理效果
            Vector3 dropDirection = (randomPos - centerPosition).normalized;
            fishItem.Drop(randomPos, true, dropDirection, 45f);
        }
    }
    
    /// <summary>
    /// 根据幸运值选择鱼的种类
    /// </summary>
    private int SelectFishType(float luck)
    {
        // 幸运值越高，稀有鱼类出现概率越大
        if (Random.value < luck * 0.3f && rareFishIDs.Length > 0)
        {
            // 选择稀有鱼类
            return rareFishIDs[Random.Range(0, rareFishIDs.Length)];
        }
        else
        {
            // 选择普通鱼类
            return commonFishIDs[Random.Range(0, commonFishIDs.Length)];
        }
    }
    
    /// <summary>
    /// 创建鱼物品实例
    /// </summary>
    private Item CreateFishItem(int fishID)
    {
        // 这里需要根据你的游戏系统实现物品创建
        // 可能的实现方式：
        // 1. 从物品预制体库中加载
        // 2. 使用物品系统API创建
        // 3. 实例化已存在的物品预制体
        
        // 示例代码（需要根据实际系统调整）：
        // return ItemAssetsCollection.InstantiateAsync(fishID).Result;
        
        Debug.Log($"创建鱼类物品，ID: {fishID}");
        return null; // 替换为实际实现
    }
}
```

### 方案二：使用游戏原版战利品系统

如果你的游戏有类似FishSpawner或LootSpawner的系统，可以这样实现：

```csharp
public class GrenadeFishingAdvanced : MonoBehaviour
{
    [Header("战利品系统配置")]
    public FishSpawner fishSpawner;     // 钓鱼战利品生成器
    public LootSpawner lootSpawner;     // 通用战利品生成器
    
    [Header("炸鱼配置")]
    public int minFishCount = 1;
    public int maxFishCount = 5;
    public float spawnRadius = 3f;
    
    /// <summary>
    /// 使用游戏原版战利品系统生成鱼
    /// </summary>
    public async void SpawnFishWithLootSystem(Vector3 explosionPosition, CharacterMainControl player)
    {
        // 获取玩家幸运值
        float luck = GetPlayerLuck(player);
        
        // 计算鱼的数量
        int fishCount = CalculateFishCount(luck);
        
        // 使用FishSpawner生成鱼
        if (fishSpawner != null)
        {
            for (int i = 0; i < fishCount; i++)
            {
                // 使用钓鱼战利品表生成鱼
                Item fishItem = await fishSpawner.Spawn(-1, luck); // -1表示无鱼饵
                
                if (fishItem != null)
                {
                    // 在爆炸位置周围随机位置生成
                    Vector3 randomPos = GetRandomPositionAround(explosionPosition);
                    fishItem.Drop(randomPos, true, Vector3.up, 45f);
                }
            }
        }
        
        // 使用LootSpawner生成额外战利品
        if (lootSpawner != null)
        {
            await lootSpawner.Setup();
            // 注意：可能需要修改LootSpawner以支持自定义生成位置
        }
    }
    
    // 其他辅助方法同方案一...
}
```

## 集成到爆炸系统

### 爆炸检测与炸鱼触发

```csharp
public class ExplosionToFishing : MonoBehaviour
{
    [Header("爆炸检测配置")]
    public LayerMask waterLayer;        // 水层掩码
    public float explosionRadius = 5f;   // 爆炸影响半径
    public GrenadeFishing grenadeFishing; // 炸鱼组件
    
    /// <summary>
    /// 爆炸事件处理
    /// </summary>
    public void OnExplosion(Vector3 explosionPosition, CharacterMainControl attacker)
    {
        // 检测爆炸位置是否在水中
        if (IsExplosionInWater(explosionPosition))
        {
            // 触发炸鱼
            grenadeFishing.SpawnFishAtExplosion(explosionPosition, attacker);
        }
    }
    
    /// <summary>
    /// 检测爆炸位置是否在水中
    /// </summary>
    private bool IsExplosionInWater(Vector3 position)
    {
        // 使用射线检测或碰撞检测判断是否在水中
        Collider[] waterColliders = Physics.OverlapSphere(position, 1f, waterLayer);
        return waterColliders.Length > 0;
    }
}
```

## 参数调优建议

### 幸运值影响

| 幸运值范围 | 鱼数量 | 稀有鱼概率 | 建议调整 |
|-----------|--------|-----------|----------|
| 0.0-0.2   | 1-2    | 5%        | 基础奖励 |
| 0.2-0.5   | 2-3    | 10%       | 中等奖励 |
| 0.5-0.8   | 3-4    | 20%       | 良好奖励 |
| 0.8-1.0   | 4-5    | 30%       | 高级奖励 |

### 生成半径建议

- **小范围** (1-2米): 适合小型水池，鱼群集中
- **中范围** (2-4米): 适合中型水域，鱼群分散
- **大范围** (4-6米): 适合大型水域，鱼群广泛分布

## 常见问题与解决方案

### 1. 物品生成失败

**问题**: 调用`CreateFishItem()`返回null
**解决方案**: 
- 检查物品ID是否正确
- 确认物品预制体是否已加载
- 验证物品系统是否正确初始化

### 2. 鱼类生成位置不合理

**问题**: 鱼生成在地面下或水面上
**解决方案**:
- 调整`randomPos.y`计算，确保鱼在水面附近
- 添加地面检测，避免鱼生成在地面下

### 3. 幸运值获取失败

**问题**: `GetStatValue()`返回0或异常
**解决方案**:
- 检查角色是否有效
- 确认幸运值属性键是否正确
- 添加默认值处理

## 性能优化建议

1. **对象池**: 为鱼类物品使用对象池，减少实例化开销
2. **异步加载**: 使用异步方法加载物品资源
3. **批量生成**: 一次性生成多条鱼，减少单独调用的开销
4. **距离剔除**: 只在玩家附近生成鱼，远处使用简化效果

## 完整示例代码

```csharp
using UnityEngine;
using System.Collections.Generic;

/// <summary>
/// 手雷炸鱼系统 - 完整实现
/// </summary>
public class GrenadeFishingSystem : MonoBehaviour
{
    [System.Serializable]
    public class FishConfig
    {
        public int fishID;
        public float spawnChance; // 生成概率 (0-1)
        public bool isRare;       // 是否为稀有鱼
    }
    
    [Header("炸鱼配置")]
    public int minFishCount = 1;
    public int maxFishCount = 5;
    public float spawnRadius = 3f;
    public float luckMultiplier = 1.5f;
    
    [Header("鱼类配置")]
    public List<FishConfig> commonFish = new List<FishConfig>();
    public List<FishConfig> rareFish = new List<FishConfig>();
    
    [Header("检测配置")]
    public LayerMask waterLayer = 1; // 默认第1层为水层
    public float waterCheckRadius = 1f;
    
    // 对象池
    private Queue<GameObject> fishPool = new Queue<GameObject>();
    public GameObject fishPrefab; // 鱼的预制体
    
    /// <summary>
    /// 处理爆炸事件
    /// </summary>
    public void HandleExplosion(Vector3 explosionPosition, CharacterMainControl attacker)
    {
        if (IsInWater(explosionPosition))
        {
            SpawnFish(explosionPosition, attacker);
        }
    }
    
    /// <summary>
    /// 检测位置是否在水中
    /// </summary>
    private bool IsInWater(Vector3 position)
    {
        Collider[] colliders = Physics.OverlapSphere(position, waterCheckRadius, waterLayer);
        return colliders.Length > 0;
    }
    
    /// <summary>
    /// 生成鱼
    /// </summary>
    private void SpawnFish(Vector3 position, CharacterMainControl player)
    {
        float luck = GetPlayerLuck(player) * luckMultiplier;
        int fishCount = CalculateFishCount(luck);
        
        for (int i = 0; i < fishCount; i++)
        {
            Vector3 spawnPos = GetRandomSpawnPosition(position);
            int fishID = SelectFishByLuck(luck);
            
            CreateFishAtPosition(fishID, spawnPos);
        }
    }
    
    /// <summary>
    /// 获取玩家幸运值
    /// </summary>
    private float GetPlayerLuck(CharacterMainControl player)
    {
        if (player == null || player.CharacterItem == null)
            return 0.5f;
            
        try
        {
            return player.CharacterItem.GetStatValue("FishingQualityFactor".GetHashCode());
        }
        catch
        {
            Debug.LogWarning("无法获取玩家幸运值，使用默认值");
            return 0.5f;
        }
    }
    
    /// <summary>
    /// 计算鱼的数量
    /// </summary>
    private int CalculateFishCount(float luck)
    {
        return Mathf.RoundToInt(Mathf.Lerp(minFishCount, maxFishCount, luck));
    }
    
    /// <summary>
    /// 获取随机生成位置
    /// </summary>
    private Vector3 GetRandomSpawnPosition(Vector3 center)
    {
        Vector2 randomCircle = Random.insideUnitCircle * spawnRadius;
        return new Vector3(center.x + randomCircle.x, center.y, center.z + randomCircle.y);
    }
    
    /// <summary>
    /// 根据幸运值选择鱼
    /// </summary>
    private int SelectFishByLuck(float luck)
    {
        // 根据幸运值决定是否选择稀有鱼
        bool selectRare = Random.value < luck * 0.3f;
        
        List<FishConfig> fishList = selectRare ? rareFish : commonFish;
        
        if (fishList.Count == 0)
        {
            // 如果没有配置对应稀有度的鱼，使用另一种
            fishList = selectRare ? commonFish : rareFish;
        }
        
        if (fishList.Count == 0)
        {
            Debug.LogWarning("没有配置任何鱼类");
            return -1;
        }
        
        // 根据概率选择鱼
        float totalChance = 0f;
        foreach (var fish in fishList)
        {
            totalChance += fish.spawnChance;
        }
        
        float randomValue = Random.value * totalChance;
        float currentChance = 0f;
        
        foreach (var fish in fishList)
        {
            currentChance += fish.spawnChance;
            if (randomValue <= currentChance)
            {
                return fish.fishID;
            }
        }
        
        // 默认返回第一条鱼
        return fishList[0].fishID;
    }
    
    /// <summary>
    /// 在指定位置创建鱼
    /// </summary>
    private void CreateFishAtPosition(int fishID, Vector3 position)
    {
        // 这里需要根据你的游戏系统实现
        // 示例：使用对象池
        GameObject fishObj = GetFishFromPool();
        fishObj.transform.position = position;
        fishObj.SetActive(true);
        
        // 添加物理效果
        Rigidbody rb = fishObj.GetComponent<Rigidbody>();
        if (rb != null)
        {
            rb.isKinematic = false;
            rb.AddForce(Vector3.up * 2f, ForceMode.Impulse);
        }
        
        Debug.Log($"在位置 {position} 生成鱼，ID: {fishID}");
    }
    
    /// <summary>
    /// 从对象池获取鱼
    /// </summary>
    private GameObject GetFishFromPool()
    {
        if (fishPool.Count > 0)
        {
            return fishPool.Dequeue();
        }
        
        // 如果池中没有，创建新的
        if (fishPrefab != null)
        {
            return Instantiate(fishPrefab);
        }
        
        Debug.LogError("没有配置鱼的预制体");
        return null;
    }
    
    /// <summary>
    /// 将鱼返回对象池
    /// </summary>
    public void ReturnFishToPool(GameObject fish)
    {
        fish.SetActive(false);
        fishPool.Enqueue(fish);
    }
}
```

## 总结

本指南提供了在手雷炸鱼Mod中实现物品生成的完整解决方案，包括：

1. **核心API使用**：Item.Drop()方法和幸运值获取
2. **两种实现方案**：简单实现和使用原版战利品系统
3. **参数调优建议**：平衡游戏体验
4. **性能优化**：对象池和异步加载
5. **完整示例代码**：可直接使用的实现

根据你的项目需求，可以选择适合的实现方案，并调整参数以获得最佳游戏体验。
</parameter>